; Supervisor configuration for Railway production - manages PHP-FPM and Nginx
; DO NOT USE: server:start, php -S, or symfony serve
; Architecture: Supervisor → PHP-FPM (TCP 127.0.0.1:9000) → Nginx (TCP 0.0.0.0:$PORT)

[supervisord]
nodaemon = true
logfile = /var/log/supervisor/supervisord.log
pidfile = /var/run/supervisord.pid
user = root
mail_host = localhost

[unix_http_server]
file = /var/run/supervisor.sock
chmod = 0700

[supervisorctl]
serverurl = unix:///var/run/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

; ============================================================================
; PHP-FPM Process (starts FIRST - priority 10)
; Listens on TCP socket 127.0.0.1:9000 for Nginx
; ============================================================================
[program:php-fpm]
command = %(ENV_PHP_FPM_CMD)s
autostart = true
autorestart = true
stderr_logfile = /var/log/supervisor/php-fpm.err.log
stdout_logfile = /var/log/supervisor/php-fpm.out.log
stdout_logfile_maxbytes = 10MB
stdout_logfile_backups = 10
priority = 10
startsecs = 15
stopasgroup = true
killasgroup = true
process_name = %(program_name)s_%(process_num)02d
; Inherit environment variables from parent process
environment = PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",APP_ENV=%(ENV_APP_ENV)s,APP_DEBUG=%(ENV_APP_DEBUG)s,APP_SECRET=%(ENV_APP_SECRET)s

; ============================================================================
; Nginx Process (starts SECOND - priority 20, after PHP-FPM is ready)
; Listens on 0.0.0.0:$PORT for Railway
; ============================================================================
[program:nginx]
command = /usr/sbin/nginx -g "daemon off;"
autostart = true
autorestart = true
stderr_logfile = /var/log/supervisor/nginx.err.log
stdout_logfile = /var/log/supervisor/nginx.out.log
stdout_logfile_maxbytes = 10MB
stdout_logfile_backups = 10
priority = 20
startsecs = 5
stopasgroup = true
killasgroup = true
process_name = %(program_name)s

; ============================================================================
; Grouped Process Management
; ============================================================================
[group:app]
programs = php-fpm,nginx
priority = 999
