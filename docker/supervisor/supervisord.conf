; Supervisor configuration for Railway production
; Manages PHP-FPM and Nginx processes
; Architecture: Supervisor â†’ PHP-FPM (127.0.0.1:9000) + Nginx (0.0.0.0:$PORT)
; DO NOT USE: server:start, php -S, or symfony serve

[supervisord]
; Run in foreground for Docker/Railway (required)
nodaemon = true

; For Docker: don't manage logfile, only child process logs matter
; Use silent=true to suppress supervisord's own logging (we only care about PHP-FPM + Nginx)
silent = true
loglevel = info
childlogdir = /var/log/supervisor

pidfile = /var/run/supervisord.pid
user = root
mail_host = localhost

; Auto-reload config changes
autochildlogdir = true
childlogdir_mode = 0700

[unix_http_server]
file = /var/run/supervisor.sock
chmod = 0700

[supervisorctl]
serverurl = unix:///var/run/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

; ============================================================================
; PHP-FPM Process (PRIORITY 10: starts first)
; Listens on TCP socket 127.0.0.1:9000 for Nginx
; ============================================================================
[program:php-fpm]
command = %(ENV_PHP_FPM_CMD)s
autostart = true
autorestart = true

; ========================================================================
; Logging - CRITICAL for diagnosing PHP-FPM startup failures
; ========================================================================
; Log to stdout/stderr so Docker captures them
stdout_logfile = /dev/stdout
stdout_logfile_maxbytes = 0
stderr_logfile = /dev/stderr
stderr_logfile_maxbytes = 0

; Backup logs for inspection
stdout_logfile_backups = 5
stderr_logfile_backups = 5
stdout_logfile_mode = 0644
stderr_logfile_mode = 0644

; ========================================================================
; Process management
; ========================================================================
priority = 10
startsecs = 15
stopsignal = TERM
stopasgroup = true
killasgroup = true

process_name = %(program_name)s_%(process_num)02d
numprocs = 1

; ========================================================================
; CRITICAL: Pass environment variables to PHP-FPM processes
; clear_env = no: Ensures APP_ENV, APP_DEBUG, APP_SECRET, DATABASE_URL, etc.
;               are passed to PHP-FPM child processes
; ========================================================================
clear_env = no

; Explicit environment variables (backup)
env[PATH]=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
env[LANG]=C.UTF-8
env[LC_ALL]=C.UTF-8

; ============================================================================
; Nginx Process (PRIORITY 20: starts second, after PHP-FPM is ready)
; Listens on 0.0.0.0:$PORT for Railway HTTP requests
; ============================================================================
[program:nginx]
command = /usr/sbin/nginx -g "daemon off;"
autostart = true
autorestart = true

; ========================================================================
; Logging - CRITICAL for Nginx errors
; ========================================================================
stdout_logfile = /dev/stdout
stdout_logfile_maxbytes = 0
stderr_logfile = /dev/stderr
stderr_logfile_maxbytes = 0

stdout_logfile_backups = 5
stderr_logfile_backups = 5
stdout_logfile_mode = 0644
stderr_logfile_mode = 0644

; ========================================================================
; Process management
; ========================================================================
priority = 20
startsecs = 5
user = www-data
stopsignal = QUIT
stopasgroup = true
killasgroup = true

process_name = %(program_name)s

; ============================================================================
; Grouped Process Management
; ============================================================================
[group:app]
programs = php-fpm,nginx
priority = 999
