name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  APP_ENV: test
  DATABASE_URL: "sqlite:///${{ github.workspace }}/var/data/school_management_test.db"

jobs:
  # ============================================================================
  # SETUP PHASE: Environment preparation and dependency installation
  # ============================================================================
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: intl, pdo_sqlite, zip, json
          tools: composer:v2
          coverage: xdebug

      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: composer-

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --no-suggest

      - name: Display PHP version
        run: php -v

      - name: Display Composer version
        run: composer --version

      - name: Display Node version
        run: node --version

  # ============================================================================
  # VALIDATION PHASE: Code quality and standards checking
  # ============================================================================
  validation:
    name: Code Quality Validation
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: intl, pdo_sqlite, zip, json

      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: composer-

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Validate composer.json
        run: composer validate

      - name: Check PHP syntax
        run: find src tests -name "*.php" -exec php -l {} \;

      - name: PHP CS Fixer - Check PSR-12 compliance
        run: composer cs-check || true

      - name: PHPStan - Static Analysis (Level 5)
        run: composer stan

  # ============================================================================
  # DATABASE PHASE: Database setup, migrations, and fixtures
  # ============================================================================
  database:
    name: Database Setup
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: intl, pdo_sqlite, zip, json

      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: composer-

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Create database directory
        run: mkdir -p var/data

      - name: Run database migrations
        run: php bin/console doctrine:migrations:migrate --no-interaction
        env:
          DATABASE_URL: "sqlite:///${{ github.workspace }}/var/data/school_management_test.db"
          APP_ENV: test

      - name: Load test fixtures
        run: php bin/console doctrine:fixtures:load --no-interaction
        env:
          DATABASE_URL: "sqlite:///${{ github.workspace }}/var/data/school_management_test.db"
          APP_ENV: test

  # ============================================================================
  # TESTING PHASE: Unit and functional tests with code coverage
  # ============================================================================
  tests:
    name: Unit & Functional Tests
    runs-on: ubuntu-latest
    needs: [setup, database]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: intl, pdo_sqlite, zip, json
          coverage: xdebug

      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: composer-

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Create database directory
        run: mkdir -p var/data

      - name: Run migrations
        run: php bin/console doctrine:migrations:migrate --no-interaction
        env:
          DATABASE_URL: "sqlite:///${{ github.workspace }}/var/data/school_management_test.db"
          APP_ENV: test

      - name: Load fixtures
        run: php bin/console doctrine:fixtures:load --no-interaction
        env:
          DATABASE_URL: "sqlite:///${{ github.workspace }}/var/data/school_management_test.db"
          APP_ENV: test

      - name: Run PHPUnit tests with coverage
        run: php bin/phpunit --coverage-text --coverage-clover coverage.xml
        env:
          DATABASE_URL: "sqlite:///${{ github.workspace }}/var/data/school_management_test.db"
          APP_ENV: test

      - name: Check code coverage
        run: |
          COVERAGE=$(grep -oP 'Lines:\s+\K[\d.]+' <<< "$(php bin/phpunit --coverage-text 2>&1)" || echo "0")
          echo "Code Coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 75" | bc -l) )); then
            echo "❌ Code coverage is below 75% threshold"
            exit 1
          fi
          echo "✅ Code coverage meets minimum threshold"
        env:
          DATABASE_URL: "sqlite:///${{ github.workspace }}/var/data/school_management_test.db"
          APP_ENV: test

      - name: Upload coverage reports
        if: always()
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

  # ============================================================================
  # ASSETS PHASE: Frontend asset building and optimization
  # ============================================================================
  assets:
    name: Asset Building
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify assets
        run: |
          echo "⚠️  Skipping npm asset build - no package.json found"
          echo "To enable frontend asset building:"
          echo "1. Create package.json with build scripts"
          echo "2. Run: npm install"
          echo "3. Commit package-lock.json to repository"

  # ============================================================================
  # FINAL STATUS: Overall CI/CD pipeline status
  # ============================================================================
  ci-status:
    name: CI Pipeline Status
    runs-on: ubuntu-latest
    needs: [setup, validation, database, tests, assets]
    if: always()
    
    steps:
      - name: Check CI Pipeline Status
        run: |
          if [ "${{ needs.setup.result }}" = "failure" ] || \
             [ "${{ needs.validation.result }}" = "failure" ] || \
             [ "${{ needs.database.result }}" = "failure" ] || \
             [ "${{ needs.tests.result }}" = "failure" ] || \
             [ "${{ needs.assets.result }}" = "failure" ]; then
            echo "❌ CI Pipeline Failed"
            exit 1
          fi
          echo "✅ CI Pipeline Passed"
